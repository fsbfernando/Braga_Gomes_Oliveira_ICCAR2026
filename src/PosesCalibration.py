import rtde_control
import cv2
import os
import time
import numpy as np
import pyrealsense2 as rs

# =========================
# CONFIGURAÇÕES
# =========================
ROBOT_IP = "169.254.206.123"
SAVE_DIR_EXT = r"./Extrinsics_v2"
os.makedirs(SAVE_DIR_EXT, exist_ok=True)
SAVE_DIR_INT = r"./Intrinsics_v2"
os.makedirs(SAVE_DIR_INT, exist_ok=True)

# POSES_INT = [
#     [1.1252455711364746, -1.5072922271541138, 1.032447640095846, -1.0942085546306153, -1.5653427282916468, -0.4463256041156214],
#     [0.9332928657531738, -1.2204039853862305, 0.6026242415057581, -0.7565285724452515, -1.4463418165790003, -0.3891947905169886],
#     [1.4739097356796265, -1.3097886902144928, 0.9424350897418421, -1.121842698459961, -1.808070484791891, -0.4000967184649866],
#     [1.876655101776123, -1.2644179624370118, 1.069019619618551, -1.1809082490256806, -2.113505188618795, -0.3993328253375452],
#     [1.8067781925201416, -2.1249739132323207, 2.161931816731588, -2.0047041378416957, -2.0076406637774866, 0.3420836925506592],
#     [0.8156006336212158, -2.0561706028380335, 1.6656106154071253, -1.420404927139618, -1.4005373159991663, -1.0791891256915491],
#     [0.6052191257476807, -1.586649557153219, 1.31567889848818, -1.2262369257262726, -1.2520406881915491, -2.438813034688131],
#     [0.6537118554115295, -1.113391475086548, 0.8366306463824671, -0.941854791050293, -1.2651312986956995, -2.4394570032702845],
#     [0.47113606333732605, -1.0022691053203125, 1.0777376333819788, -1.009387807255127, -1.1429193655597132, -2.575430218373434],
#     [1.853661298751831, -1.2707714301398774, 1.1332572142230433, -1.327276275759079, -1.9713004271136683, 1.924635887145996],
#     [2.0578103065490723, -1.1308285158923645, 1.2697346846209925, -1.3882080179503937, -2.179176155720846, 1.8715869188308716],
#     [2.0117175579071045, -0.9370542925647278, 1.0155366102801722, -1.2317546171000977, -2.170245949422018, 2.255279541015625],
#     [2.1384127140045166, -0.8276262444308777, 1.1900494734393519, -1.2837067407420655, -2.335697952901022, 2.246957778930664],
#     [1.2620795965194702, -0.9322694104960938, 0.1984160582171839, -0.5920937818339844, -1.6385486761676233, -0.17762929597963506],
#     [0.8540923595428467, -0.9296396535686036, 0.33196908632387334, -0.5505870145610352, -1.3602889219867151, -0.06593925157655889],
#     [0.6690900325775146, -1.2590074998191376, 0.6440766493426722, -0.6470352572253724, -1.2874329725848597, -0.06630307832826787],
#     [0.6126589179039001, -1.0257974427989502, 0.7827070395099085, -0.7078262132457276, -1.2201994101153772, -0.043206040059224904],
#     [0.6282021999359131, -0.8990953725627442, 0.7218578497516077, -0.6584576529315491, -1.200331989918844, -0.054557148610250294]
# ]

POSES_INT = [
    [1.1943293809890747, -1.205460087662079, 2.253467861806051, -2.6178699932494105, -1.5678489843951624, -0.371681038533346],
    [1.1145634651184082, -1.2021685999682923, 2.177420441304342, -2.375233312646383, -1.4124301115619105, -0.20363027254213506],
    [1.38555908203125, -1.0495806497386475, 1.6729586760150355, -1.7109881840147914, -1.8076699415790003, -0.3990419546710413],
    [1.5847983360290527, -1.0959032338908692, 2.0824597517596644, -2.5439354381956996, -2.1444361845599573, -0.7368105093585413],
    [1.3837298154830933, -0.8804910939982911, 2.7151146570788782, -3.939988513986105, -1.821564022694723, -0.05640727678407842],
    [1.0787911415100098, -1.2148469251445313, 2.4912005106555384, -3.12186922649526, -1.4718802610980433, -0.8167789618121546],
    [0.9795763492584229, -1.2420453292182465, 2.1829898993121546, -2.5639974079527796, -1.2492898146258753, -2.039243523274557],
    [0.9492177963256836, -1.0549380344203492, 1.8770816961871546, -2.1450869045653285, -1.1765854994403284, -2.134627167378561],
    [0.7043335437774658, -1.0392370384982605, 2.014134709035055, -2.0148173771300257, -1.013080898915426, -2.350995127354757],
    [1.6929110288619995, -1.082025722866394, 1.9751585165606897, -2.4260860882201136, -1.983398739491598, 1.754293441772461],
    [1.7843602895736694, -0.9842360776713868, 2.029433552418844, -2.4925905666747035, -2.2405460516559046, 1.543083906173706],
    [1.8284449577331543, -0.9273829025081177, 1.80251390138735, -2.1528388462462367, -2.233875576649801, 2.0460867881774902],
    [1.8521661758422852, -0.7895050805858155, 1.8745268026935022, -2.2829510174193324, -2.4773836771594446, 1.877886176109314],
    [1.2143783569335938, -1.1378556054881592, 1.9048641363727015, -2.09615482906484, -1.6478727499591272, -0.21933156648744756],
    [1.0934114456176758, -1.123255805378296, 1.7601984182940882, -1.8440472088255824, -1.265895191823141, 0.16638588905334473],
    [1.0422234535217285, -1.283144788151123, 2.1264222303973597, -2.231229444543356, -1.1941946188556116, 0.32154759764671326],
    [0.9516639709472656, -1.2130444806865235, 1.9420822302447718, -1.818094869653219, -1.0394647757159632, 0.2793705463409424],
    [0.8887524604797363, -1.041872815494873, 1.7902701536761683, -1.68373503307485, -1.0328663031207483, 0.17279554903507233]
]

# POSES_EXT = [
#     [1.1252455711364746, -1.5072652784040947, 1.0323689619647425, -1.0941847127727051, -1.565453831349508, -0.4463608900653284],
#     [1.9130936861038208, -1.0447195333293458, 0.8346756140338343, -0.977573887710907, -2.0907896200763147, 0.4840555191040039],
#     [0.318087100982666, -1.1023972791484375, 0.9709461371051233, -0.7444621485522767, -1.2005718390094202, -1.3123701254474085],
#     [-0.16595107713808233, -1.2344814401916047, 1.6331904570208948, -1.0312393468669434, -1.091849152241842, -2.758976761494772],
#     [2.436007499694824, -1.7620049915709437, 2.0450008551227015, -1.8079363308348597, -2.3419821898089808, 1.8127002716064453],
#     [1.1027387380599976, -2.159402986566061, 1.6003039518939417, -1.3961873811534424, -1.5360048452960413, -0.36308175722231084],
#     [1.9819324016571045, -1.0230125349811097, 0.8362143675433558, -1.0617656868747254, -2.071157757435934, 1.7577323913574219],
#     [1.2975116968154907, -1.3394968074611207, 0.8837326208697718, -1.038951353435852, -1.6626413504229944, -0.13010818163026983],
#     [0.8299600481987, -0.7512410444072266, 0.21470767656435186, -0.454913930302002, -1.3088348547564905, 0.23012952506542206],
#     [0.4779233932495117, -0.7907395523837586, 0.8001592795001429, -0.7820279759219666, -1.1821320692645472, -2.1405022780047815],
#     [0.8997366428375244, -0.9158194822124024, 0.4788149038897913, -0.8106828492930909, -1.420959774647848, -2.199932877217428],
#     [1.7539407014846802, -1.1203058522990723, 0.7421940008746546, -0.9966947597316285, -1.900837246571676, 1.2313642501831055],
#     [2.8384101390838623, -1.976727148095602, 2.2684529463397425, -1.6247245273985804, -2.462930742894308, 2.038419485092163],
#     [-0.23119956651796514, -1.990467210809225, 1.7331464926349085, -0.7997512978366395, -1.0038755575763147, 1.88277268409729],
#     [1.0032362937927246, -1.215843991642334, 0.49907142320741826, -0.7042339605144043, -1.4945781866656702, -0.4524019400226038],
#     [1.488135814666748, -1.022748963241913, 0.27989179292787725, -0.7023887795260926, -1.8151066938983362, -0.709566895161764],
#     [0.5010433197021484, -1.1166771215251465, 0.8016212622271937, -0.6593719881824036, -1.1707528273211878, 0.23819424211978912],
#     [0.3680243492126465, -1.0799921315959473, 1.249723259602682, -0.8506456178477784, -1.0287120977984827, 0.32996103167533875],
#     [0.7609977722167969, -1.8376690349974574, 1.0292800108539026, -0.9154551786235352, -1.3939903418170374, -0.854473892842428],
#     [0.4844479560852051, -1.6094256840147914, 0.9766886870013636, -0.7769674819758912, -1.2785947958575647, -0.7840426603900355],
#     [1.629453182220459, -1.85363831142568, 1.1933754126178187, -1.1805761617473145, -1.8345673719989222, -0.038482014332906544],
#     [1.3189301490783691, -2.1231733761229457, 1.9238165060626429, -1.7494951687254847, -1.6953986326800745, -0.34727651277651006],
#     [1.4062128067016602, -0.9871159356883545, 0.4045632521258753, -0.7632982295802613, -1.7344964186297815, -0.06322175661195928],
#     [1.7839720249176025, -0.6806193155101319, 0.38590985933412725, -0.6726845067790528, -2.0664261023150843, 0.33317211270332336],
#     [2.058398723602295, -0.7326505345157166, 0.7138398329364222, -0.7978061002543946, -2.246145550404684, 0.670194149017334],
#     [0.33418893814086914, -0.9478185933879395, 1.2161677519427698, -1.023205356006958, -1.0754950682269495, -2.7323761622058313],
#     [-0.4255183378802698, -1.256551371221878, 1.7446935812579554, -0.9866636556437989, -1.1379335562335413, -3.10561448732485],
#     [-0.370734993611471, -1.797049184838766, 1.4948766867267054, -0.6668799680522461, -1.1335910002337855, -3.080052439366476],
#     [-0.30984193483461553, -1.781363149682516, 1.817035977040426, -0.9589509528926392, -1.0964925924884241, -3.123688284550802],
#     [1.192544937133789, -0.9046898645213624, 0.2966049353228968, -0.6504081052592774, -1.5857966581927698, -0.1253598372088831]
# ]

POSES_EXT = [
    [1.1993592977523804, -1.2925370198539277, 2.213640038167135, -2.490289350549215, -1.5659616629229944, -0.36709529558290654],
    [1.6184358596801758, -1.090883569126465, 2.0157840887652796, -2.2902232609190882, -2.17627460161318, 0.15514755249023438],
    [0.7398600578308105, -1.1203023952296753, 2.231387440358297, -2.1776844463744105, -0.9579718748675745, -0.9129303137408655],
    [0.7378513813018799, -0.9424106639674683, 2.0093076864825647, -2.143028875390524, -0.8869002501117151, -2.2893860975848597],
    [1.5887103080749512, -1.164788083439209, 2.4010325113879603, -3.0601569614806117, -1.9022858778582972, 1.1395463943481445],
    [1.1952508687973022, -1.2427945596030732, 2.6023669878589075, -3.315976758996481, -1.5754559675799769, -0.27153188387026006],
    [1.7410377264022827, -1.051025466328003, 1.9528301397906702, -2.286384244958395, -2.1315959135638636, 1.491808295249939],
    [1.2476495504379272, -1.2328334015658875, 2.074038807545797, -2.283748289147848, -1.6061299482928675, -0.07680255571474248],
    [1.0538923740386963, -1.1181535583785553, 1.90027362505068, -1.8381887874998988, -1.1891372839557093, 0.4354720115661621],
    [0.7694976329803467, -0.9473424714854737, 1.9171207586871546, -1.8584643803038539, -0.9829886595355433, -1.8934944311725062],
    [1.0610463619232178, -1.038297490482666, 1.7566326300250452, -1.9933926067748011, -1.3703926245318812, -2.0399821440326136],
    [1.6468499898910522, -1.1977663499167939, 1.9692652861224573, -2.1824728451170863, -1.9190276304828089, 1.1239049434661865],
    [1.6235771179199219, -0.9314652246287842, 2.505230967198507, -3.6385399303831996, -2.041294876729147, 0.8383195400238037],
    [0.7365059852600098, -1.3255813878825684, 2.500331226979391, -3.020827909509176, -0.8704021612750452, 3.1110966205596924],
    [1.1694785356521606, -1.2882910531810303, 2.0044615904437464, -2.1517964802184046, -1.4693077246295374, -0.28218299547304326],
    [1.4745641946792603, -1.2674310964396973, 1.9289615789996546, -2.1089960537352503, -1.8149784247027796, -0.7188027540790003],
    [0.9428036212921143, -1.26645381868396, 2.0628798643695276, -1.9918958149352015, -0.9589780012713831, 0.6889619827270508],
    [0.6406355500221252, -1.370182828312256, 2.136451546345846, -1.5877844295897425, -0.8273428122149866, 0.5642639398574829],
    [0.9383981227874756, -1.3671234411052247, 2.4765141646014612, -2.8622991047301234, -1.425262753163473, -0.670572582875387],
    [0.9137909412384033, -1.3362086874297638, 2.502749745045797, -2.717045923272604, -1.2396252791034144, -0.32789546648134404],
    [1.197526454925537, -1.4065971833518525, 2.461768452321188, -2.979978223840231, -1.7020123640643519, -0.45158225694765264],
    [1.2639522552490234, -1.2191272538951416, 2.5640698114978235, -3.2994448147215785, -1.6796382109271448, -0.3942073027240198],
    [1.3801546096801758, -1.085827187900879, 1.8996933142291468, -2.163290639916891, -1.7387960592852991, -0.08425361314882451],
    [1.6168994903564453, -0.9650028508952637, 1.6871102491961878, -1.7729045353331507, -2.153325859700338, 0.17196154594421387],
    [1.7265890836715698, -1.0959068101695557, 1.810932461415426, -1.7965933285155238, -2.440213982258932, 0.29618126153945923],
    [0.6308794021606445, -0.974036769276001, 2.03261644044985, -1.9644485912718714, -0.8733890692340296, -2.4644656817065638],
    [0.6668570041656494, -1.6833826504149378, 2.4597929159747522, -2.335269113580221, -1.2042411009417933, -1.5787237326251429],
    [0.6927103996276855, -1.2735412877849122, 2.459290091191427, -2.9176155529417933, -0.8590124289142054, -1.8120868841754358],
    [0.5660901069641113, -1.2468794149211426, 2.705341164265768, -3.040305276910299, -0.7909615675555628, -2.0753782431231897],
    [1.2136423587799072, -1.1208892625621338, 1.9546225706683558, -2.091872354547018, -1.5773232618915003, -0.10064202943910772]
]

# =========================
# INICIA ROBÔ
# =========================
rtde_c = rtde_control.RTDEControlInterface(ROBOT_IP)

# =========================
# INICIA CÂMERA (RealSense - só RGB)
# =========================
pipeline = rs.pipeline()
config = rs.config()

COLOR_W, COLOR_H = 1280, 720
TARGET_W, TARGET_H = 640, 480

config.enable_stream(rs.stream.color, TARGET_W, TARGET_H, rs.format.bgr8, 30)

profile = pipeline.start(config)

# "Aquece" a câmera pra auto-exposure estabilizar
for _ in range(30):
    pipeline.wait_for_frames()

def get_center_crop(img_bgr, target_w=1000, target_h=1000):
    h, w = img_bgr.shape[:2]
    tw = min(target_w, w)
    th = min(target_h, h)
    x0 = (w - tw) // 2
    y0 = (h - th) // 2
    return img_bgr[y0:y0+th, x0:x0+tw]

# =========================
# LOOP SOBRE AS POSES INTRINSICS
# =========================
for i, pose in enumerate(POSES_INT):
    print(f"Movendo para pose {i+1}/{len(POSES_INT)}...")
    rtde_c.moveJ(pose, 1.5, 0.5)
    time.sleep(0.3)

    # Captura imagem
    frames = pipeline.wait_for_frames(2000)
    color_frame = frames.get_color_frame()
    if color_frame:
        img = np.asanyarray(color_frame.get_data())
        # img = get_center_crop(img, TARGET_W, TARGET_H)

        filename = os.path.join(SAVE_DIR_INT, f"{i:04d}_img.png")
        cv2.imwrite(filename, img)
        print(f"Imagem salva: {filename}")

    time.sleep(0.3)

# =========================
# LOOP SOBRE AS POSES EXTRINSICS
# =========================
for i, pose in enumerate(POSES_EXT):
    print(f"Movendo para pose {i+1}/{len(POSES_EXT)}...")
    rtde_c.moveJ(pose, 1.5, 0.5)
    time.sleep(0.3)

    # Captura imagem
    frames = pipeline.wait_for_frames(5000)
    color_frame = frames.get_color_frame()
    if color_frame:
        img = np.asanyarray(color_frame.get_data())
        img = get_center_crop(img, TARGET_W, TARGET_H)

        filename = os.path.join(SAVE_DIR_EXT, f"{i:04d}_img.png")
        cv2.imwrite(filename, img)
        print(f"Imagem salva: {filename}")

    time.sleep(0.3)

# =========================
# FINALIZA
# =========================
pipeline.stop()
rtde_c.stopScript()
print("Captura concluída.")
