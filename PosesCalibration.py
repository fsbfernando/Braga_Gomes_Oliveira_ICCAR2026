import rtde_control
from pypylon import pylon
import cv2
import os
import time

# =========================
# CONFIGURAÇÕES
# =========================
ROBOT_IP = "169.254.206.123"
SAVE_DIR_EXT = r"./Extrinsics"
os.makedirs(SAVE_DIR_EXT, exist_ok=True)
SAVE_DIR_INT = r"./Intrinsics"
os.makedirs(SAVE_DIR_INT, exist_ok=True)

POSES_INT = [
    	[1.1252455711364746, -1.5072922271541138, 1.032447640095846, -1.0942085546306153, -1.5653427282916468, -0.4463256041156214],
	[0.9332928657531738, -1.2204039853862305, 0.6026242415057581, -0.7565285724452515, -1.4463418165790003, -0.3891947905169886],
	[1.4739097356796265, -1.3097886902144928, 0.9424350897418421, -1.121842698459961, -1.808070484791891, -0.4000967184649866],
	[1.876655101776123, -1.2644179624370118, 1.069019619618551, -1.1809082490256806, -2.113505188618795, -0.3993328253375452],
	[1.8067781925201416, -2.1249739132323207, 2.161931816731588, -2.0047041378416957, -2.0076406637774866, 0.3420836925506592],
	[0.8156006336212158, -2.0561706028380335, 1.6656106154071253, -1.420404927139618, -1.4005373159991663, -1.0791891256915491],
	[0.6052191257476807, -1.586649557153219, 1.31567889848818, -1.2262369257262726, -1.2520406881915491, -2.438813034688131],
	[0.6537118554115295, -1.113391475086548, 0.8366306463824671, -0.941854791050293, -1.2651312986956995, -2.4394570032702845],
	[0.47113606333732605, -1.0022691053203125, 1.0777376333819788, -1.009387807255127, -1.1429193655597132, -2.575430218373434],
	[1.853661298751831, -1.2707714301398774, 1.1332572142230433, -1.327276275759079, -1.9713004271136683, 1.924635887145996],
	[2.0578103065490723, -1.1308285158923645, 1.2697346846209925, -1.3882080179503937, -2.179176155720846, 1.8715869188308716],
	[2.0117175579071045, -0.9370542925647278, 1.0155366102801722, -1.2317546171000977, -2.170245949422018, 2.255279541015625],
	[2.1384127140045166, -0.8276262444308777, 1.1900494734393519, -1.2837067407420655, -2.335697952901022, 2.246957778930664],
	[1.2620795965194702, -0.9322694104960938, 0.1984160582171839, -0.5920937818339844, -1.6385486761676233, -0.17762929597963506],
	[0.8540923595428467, -0.9296396535686036, 0.33196908632387334, -0.5505870145610352, -1.3602889219867151, -0.06593925157655889],
	[0.6690900325775146, -1.2590074998191376, 0.6440766493426722, -0.6470352572253724, -1.2874329725848597, -0.06630307832826787],
	[0.6126589179039001, -1.0257974427989502, 0.7827070395099085, -0.7078262132457276, -1.2201994101153772, -0.043206040059224904],
	[0.6282021999359131, -0.8990953725627442, 0.7218578497516077, -0.6584576529315491, -1.200331989918844, -0.054557148610250294]
]

# Lista de poses (em RAD)
POSES_EXT = [
    	[1.1252455711364746, -1.5072652784040947, 1.0323689619647425, -1.0941847127727051, -1.565453831349508, -0.4463608900653284],
	[1.9130936861038208, -1.0447195333293458, 0.8346756140338343, -0.977573887710907, -2.0907896200763147, 0.4840555191040039],
	[0.318087100982666, -1.1023972791484375, 0.9709461371051233, -0.7444621485522767, -1.2005718390094202, -1.3123701254474085],
	[-0.16595107713808233, -1.2344814401916047, 1.6331904570208948, -1.0312393468669434, -1.091849152241842, -2.758976761494772],
	[2.436007499694824, -1.7620049915709437, 2.0450008551227015, -1.8079363308348597, -2.3419821898089808, 1.8127002716064453],
	[1.1027387380599976, -2.159402986566061, 1.6003039518939417, -1.3961873811534424, -1.5360048452960413, -0.36308175722231084],
	[1.9819324016571045, -1.0230125349811097, 0.8362143675433558, -1.0617656868747254, -2.071157757435934, 1.7577323913574219],
	[1.2975116968154907, -1.3394968074611207, 0.8837326208697718, -1.038951353435852, -1.6626413504229944, -0.13010818163026983],
	[0.8299600481987, -0.7512410444072266, 0.21470767656435186, -0.454913930302002, -1.3088348547564905, 0.23012952506542206],
	[0.4779233932495117, -0.7907395523837586, 0.8001592795001429, -0.7820279759219666, -1.1821320692645472, -2.1405022780047815],
	[0.8997366428375244, -0.9158194822124024, 0.4788149038897913, -0.8106828492930909, -1.420959774647848, -2.199932877217428],
	[1.7539407014846802, -1.1203058522990723, 0.7421940008746546, -0.9966947597316285, -1.900837246571676, 1.2313642501831055],
	[2.8384101390838623, -1.976727148095602, 2.2684529463397425, -1.6247245273985804, -2.462930742894308, 2.038419485092163],
	[-0.23119956651796514, -1.990467210809225, 1.7331464926349085, -0.7997512978366395, -1.0038755575763147, 1.88277268409729],
	[1.0032362937927246, -1.215843991642334, 0.49907142320741826, -0.7042339605144043, -1.4945781866656702, -0.4524019400226038],
	[1.488135814666748, -1.022748963241913, 0.27989179292787725, -0.7023887795260926, -1.8151066938983362, -0.709566895161764],
	[0.5010433197021484, -1.1166771215251465, 0.8016212622271937, -0.6593719881824036, -1.1707528273211878, 0.23819424211978912],
	[0.3680243492126465, -1.0799921315959473, 1.249723259602682, -0.8506456178477784, -1.0287120977984827, 0.32996103167533875],
	[0.7609977722167969, -1.8376690349974574, 1.0292800108539026, -0.9154551786235352, -1.3939903418170374, -0.854473892842428],
	[0.4844479560852051, -1.6094256840147914, 0.9766886870013636, -0.7769674819758912, -1.2785947958575647, -0.7840426603900355],
	[1.629453182220459, -1.85363831142568, 1.1933754126178187, -1.1805761617473145, -1.8345673719989222, -0.038482014332906544],
	[1.3189301490783691, -2.1231733761229457, 1.9238165060626429, -1.7494951687254847, -1.6953986326800745, -0.34727651277651006],
	[1.4062128067016602, -0.9871159356883545, 0.4045632521258753, -0.7632982295802613, -1.7344964186297815, -0.06322175661195928],
	[1.7839720249176025, -0.6806193155101319, 0.38590985933412725, -0.6726845067790528, -2.0664261023150843, 0.33317211270332336],
	[2.058398723602295, -0.7326505345157166, 0.7138398329364222, -0.7978061002543946, -2.246145550404684, 0.670194149017334],
	[0.33418893814086914, -0.9478185933879395, 1.2161677519427698, -1.023205356006958, -1.0754950682269495, -2.7323761622058313],
	[-0.4255183378802698, -1.256551371221878, 1.7446935812579554, -0.9866636556437989, -1.1379335562335413, -3.10561448732485],
	[-0.370734993611471, -1.797049184838766, 1.4948766867267054, -0.6668799680522461, -1.1335910002337855, -3.080052439366476],
	[-0.30984193483461553, -1.781363149682516, 1.817035977040426, -0.9589509528926392, -1.0964925924884241, -3.123688284550802],
	[1.192544937133789, -0.9046898645213624, 0.2966049353228968, -0.6504081052592774, -1.5857966581927698, -0.1253598372088831]
]
# Você pode sobrescrever essa lista via MATLAB

# =========================
# INICIA ROBÔ
# =========================
rtde_c = rtde_control.RTDEControlInterface(ROBOT_IP)

# =========================
# INICIA CÂMERA
# =========================

camera = pylon.InstantCamera(pylon.TlFactory.GetInstance().CreateFirstDevice()) 
camera.Open() 
camera.Width.SetValue(1000) 
camera.Height.SetValue(1000) 
camera.CenterX.SetValue(False)
camera.CenterY.SetValue(False)
incX = camera.OffsetX.GetInc() 
incY = camera.OffsetY.GetInc() 
offset_x = int((camera.SensorWidth.GetValue() - camera.Width.GetValue()) / 2) 
offset_x -= offset_x % incX 
print(offset_x) 
offset_y = int((camera.SensorHeight.GetValue() - camera.Height.GetValue()) / 2) 
offset_y -= offset_y % incY 
print(offset_y) 
camera.OffsetX.SetValue(offset_x) 
camera.OffsetY.SetValue(offset_y) 
camera.StartGrabbing(pylon.GrabStrategy_LatestImageOnly) 
converter = pylon.ImageFormatConverter() 
converter.OutputPixelFormat = pylon.PixelType_BGR8packed

# =========================
# LOOP SOBRE AS POSES INTRINSICS
# =========================
for i, pose in enumerate(POSES_INT):
    print(f"Movendo para pose {i+1}/{len(POSES_INT)}...")
    rtde_c.moveJ(pose, 1.5, 0.5)	
    time.sleep(0.3)
    # Captura imagem
    result = camera.RetrieveResult(2000)
    if result.GrabSucceeded():
        img = converter.Convert(result).GetArray()

        filename = os.path.join(SAVE_DIR_INT, f"{i:04d}_img.png")
        cv2.imwrite(filename, img)
        print(f"Imagem salva: {filename}")

    result.Release()
    
    time.sleep(0.3)
    
    
# =========================
# LOOP SOBRE AS POSES EXTRINSICS
# =========================
for i, pose in enumerate(POSES_EXT):
    print(f"Movendo para pose {i+1}/{len(POSES_EXT)}...")
    rtde_c.moveJ(pose, 1.5, 0.5)	
    time.sleep(0.3)
    # Captura imagem
    result = camera.RetrieveResult(5000)
    if result.GrabSucceeded():
        img = converter.Convert(result).GetArray()

        filename = os.path.join(SAVE_DIR_EXT, f"{i:04d}_img.png")
        cv2.imwrite(filename, img)
        print(f"Imagem salva: {filename}")

    result.Release()
    
    time.sleep(0.3)


rtde_c.stopScript()
print("Captura concluída.")
